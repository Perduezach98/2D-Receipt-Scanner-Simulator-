extends Control

@onready var upload_btn := $Root/TopBar/UploadBtn
@onready var export_btn := $Root/TopBar/ExportBtn
@onready var progress := $Root/Progress
@onready var history_list := $Root/Body/HistoryList
@onready var detail_text := $Root/Body/DetailPanel/DetailBox/DetailText
@onready var file_dialog := $FileDialog

var receipts: Array = []
var is_processing := false
var rng := RandomNumberGenerator.new()

func _ready():
	rng.randomize()
	upload_btn.pressed.connect(_on_upload_pressed)
	export_btn.pressed.connect(_on_export_pressed)
	file_dialog.file_selected.connect(_on_file_selected)
	history_list.item_selected.connect(_on_history_selected)
	_render_detail(null)

func _on_upload_pressed():
	if is_processing:
		return
	file_dialog.popup_centered_ratio(0.8)

func _on_file_selected(path: String):
	if is_processing:
		return
	_start_processing(path)

func _start_processing(path: String):
	is_processing = true
	progress.visible = true
	progress.value = 0
	upload_btn.disabled = true
	export_btn.disabled = true

	var t := Timer.new()
	t.one_shot = false
	t.wait_time = 0.03
	add_child(t)

	t.timeout.connect(func():
		progress.value += rng.randi_range(1, 5)
		if progress.value >= 100:
			t.stop()
			t.queue_free()
			_finish_processing(path)
	)

	t.start()

func _finish_processing(path: String):
	var receipt := _fake_ocr_extract(path)
	receipts.append(receipt)
	_add_history_item(receipt)
	_render_detail(receipt)

	progress.visible = false
	is_processing = false
	upload_btn.disabled = false
	export_btn.disabled = false

func _fake_ocr_extract(path: String) -> Dictionary:
	var merchants = ["QuickMart", "Green Basket", "Urban Eats", "Metro Pharmacy", "Cafe Nova", "City Supplies"]
	var categories = ["Meals", "Groceries", "Transport", "Health", "Office", "Other"]

	var merchant := merchants[rng.randi_range(0, merchants.size() - 1)]
	var category := categories[rng.randi_range(0, categories.size() - 1)]

	var year := 2026
	var month := rng.randi_range(1, 12)
	var day := rng.randi_range(1, 28)
	var date_str := "%04d-%02d-%02d" % [year, month, day]

	var total := snapped(rng.randf_range(2.50, 120.00), 0.01)

	return {
		"id": "RCPT-%06d" % rng.randi_range(1, 999999),
		"file_path": path,
		"merchant": merchant,
		"date": date_str,
		"total": total,
		"currency": "USD",
		"category": category,
		"status": "completed"
	}

func _add_history_item(receipt: Dictionary):
	var label := "%s  |  %s  |  $%.2f" % [receipt["date"], receipt["merchant"], receipt["total"]]
	history_list.add_item(label)

func _on_history_selected(index: int):
	if index < 0 or index >= receipts.size():
		return
	_render_detail(receipts[index])

func _render_detail(receipt):
	if receipt == null:
		detail_text.text = "Upload a receipt to see extracted fields here."
		return

	var lines: Array[String] = []
	lines.append("ID: %s" % receipt["id"])
	lines.append("Merchant: %s" % receipt["merchant"])
	lines.append("Date: %s" % receipt["date"])
	lines.append("Total: $%.2f %s" % [receipt["total"], receipt["currency"]])
	lines.append("Category: %s" % receipt["category"])
	lines.append("Status: %s" % receipt["status"])
	lines.append("File: %s" % receipt["file_path"])

	detail_text.text = "\n".join(lines)

func _on_export_pressed():
	if receipts.is_empty():
		return

	var dir := DirAccess.open("user://")
	if dir == null:
		return

	var out_path := "user://receipts_export.json"
	var json_text := JSON.stringify(receipts, "\t")

	var f := FileAccess.open(out_path, FileAccess.WRITE)
	if f == null:
		return
	f.store_string(json_text)
	f.close()

	OS.shell_open(ProjectSettings.globalize_path(out_path))
